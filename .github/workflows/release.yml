name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve release notes
        id: notes
        run: |
          tag="${GITHUB_REF_NAME}"
          notes_file="docs/releases/${tag}.md"
          if [ -f "${notes_file}" ]; then
            echo "has_notes=true" >> "${GITHUB_OUTPUT}"
            echo "body_path=${notes_file}" >> "${GITHUB_OUTPUT}"
          else
            echo "has_notes=false" >> "${GITHUB_OUTPUT}"
          fi

      - name: Publish release from checked-in notes
        if: steps.notes.outputs.has_notes == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body_path: ${{ steps.notes.outputs.body_path }}
          target_commitish: ${{ github.sha }}
          prerelease: ${{ contains(github.ref_name, '-') }}
          generate_release_notes: false

      - name: Publish release with generated notes (fallback)
        if: steps.notes.outputs.has_notes != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          target_commitish: ${{ github.sha }}
          prerelease: ${{ contains(github.ref_name, '-') }}
          generate_release_notes: true
          body: |
            No release note file found at `docs/releases/${{ github.ref_name }}.md`.
            Auto-generated release notes were used for this tag.
